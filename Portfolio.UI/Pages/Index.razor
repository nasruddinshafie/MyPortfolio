@page "/"
@using Portfolio.UI.Services
@using Portfolio.UI.Components.Bio
@using Portfolio.UI.Components.Projects
@using Portfolio.UI.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IBioService BioService
@inject IProjectService ProjectService

<PageTitle>Portfolio</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            @if (isLoading)
            {
                <div class="text-center p-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading portfolio...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="alert alert-danger">
                    <h4>Error Loading Portfolio</h4>
                    <p>@errorMessage</p>
                    <button class="btn btn-outline-danger" @onclick="LoadPortfolio">Try Again</button>
                </div>
            }
            else
            {
                <BioDisplay Bio="bio" />

                <AuthorizeView>
                    <Authorized>
                        @if (bio == null)
                        {
                            <div class="text-center mt-4 mb-4">
                                <a href="/bio/create" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Create Your Bio
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="text-center mt-4 mb-4">
                                <a href="/bio/edit" class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i> Edit Bio
                                </a>
                            </div>
                        }
                    </Authorized>
                    @* <NotAuthorized>
                        @if (bio != null)
                        {
                            <div class="text-center mt-4 mb-4">
                                <a href="/login" class="btn btn-outline-secondary">
                                    <i class="fas fa-sign-in-alt"></i> Login to Edit
                                </a>
                            </div>
                        }
                    </NotAuthorized> *@
                </AuthorizeView>

                <hr class="my-5" />

                <ProjectsDisplay Projects="projects" ShowManageLink="true" />

                <hr class="my-5" />

                <!-- Contact Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-light border-0 shadow-sm">
                            <div class="card-body text-center py-5">
                                <h2 class="display-6 mb-3">
                                    <i class="fas fa-envelope text-primary"></i> Get In Touch
                                </h2>
                                <p class="lead text-muted mb-4">
                                    Have a project in mind or want to collaborate? I'd love to hear from you!
                                </p>
                                <a href="/contact" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i> Contact Me
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private BioDto? bio;
    private List<ProjectDto>? projects;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadPortfolio();
    }

    private async Task LoadPortfolio()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Load bio and projects in parallel
            var bioTask = BioService.GetBioAsync();
            var projectsTask = ProjectService.GetAllProjectsAsync();

            await Task.WhenAll(bioTask, projectsTask);

            bio = await bioTask;
            projects = (await projectsTask).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load portfolio: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
